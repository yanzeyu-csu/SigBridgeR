name: Build R Package Manual

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # 允许手动触发

jobs:
  build-manual:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许推送更改
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
            
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-latex-extra \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev
      
      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::devtools
            any::roxygen2
          needs: build
      
      - name: Delete old manual PDFs in vignettes
        run: |
          if [ -d "vignettes" ]; then
            find vignettes -name "*.pdf" -type f -delete
            echo "Deleted old PDF files in vignettes/"
          else
            mkdir -p vignettes
            echo "Created vignettes directory"
          fi
      
      - name: Build package manual
        run: |
          devtools::build_manual(path = "vignettes")
        shell: Rscript {0}
      
      - name: Check if PDF was created
        id: check_pdf
        run: |
          PDF_COUNT=$(find vignettes -name "*.pdf" -type f | wc -l)
          if [ $PDF_COUNT -eq 0 ]; then
            echo "Error: No PDF file was created"
            exit 1
          elif [ $PDF_COUNT -gt 1 ]; then
            echo "Warning: Multiple PDF files found"
          fi
          PDF_FILE=$(find vignettes -name "*.pdf" -type f | head -n 1)
          echo "pdf_file=$PDF_FILE" >> $GITHUB_OUTPUT
          echo "Created manual: $PDF_FILE"
      
      - name: Pull latest changes
        run: |
          git fetch origin
          git merge origin/main


      - name: Commit and push changes
        run: |
          git add vignettes/*.pdf
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update package manual [ci skip]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
