name: Update R Package Version

on:
    push:
        branches: [main]
        paths:
            - "DESCRIPTION"

jobs:
    update-version:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup R
              uses: r-lib/actions/setup-r@v2

            - name: Install required packages
              run: |
                  Rscript -e 'install.packages("desc")'

            - name: Get commit message
              id: commit_msg
              run: |
                  echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

            - name: Determine version bump type
              id: version_bump
              run: |
                  if echo "${{ steps.commit_msg.outputs.msg }}" | grep -qi "major\|breaking\|feat!"; then
                    echo "type=major" >> $GITHUB_OUTPUT
                  elif echo "${{ steps.commit_msg.outputs.msg }}" | grep -qi "feat\|feature\|minor"; then
                    echo "type=minor" >> $GITHUB_OUTPUT
                  else
                    echo "type=patch" >> $GITHUB_OUTPUT
                  fi

            - name: Update version in DESCRIPTION
              id: update_version
              run: |
                  CURRENT_VERSION=$(Rscript -e 'cat(as.character(desc::desc_get_version()))')
                  echo "Current version: $CURRENT_VERSION"

                  if [ "${{ steps.version_bump.outputs.type }}" = "major" ]; then
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[1] <- as.character(as.numeric(parts[1]) + 1); parts[2] <- "0"; parts[3] <- "0"; cat(paste(parts, collapse="."))')
                  elif [ "${{ steps.version_bump.outputs.type }}" = "minor" ]; then
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[2] <- as.character(as.numeric(parts[2]) + 1); parts[3] <- "0"; cat(paste(parts, collapse="."))')
                  else
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[3] <- as.character(as.numeric(parts[3]) + 1); cat(paste(parts, collapse="."))')
                  fi

                  echo "New version: $NEW_VERSION"
                  Rscript -e "desc::desc_set_version('$NEW_VERSION')"
                  echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

            - name: Update version badge in README.md
              run: |
                  # 精确匹配徽章格式
                  sed -i "s/\(badge\/devel%20version-\)[0-9]\+\.[0-9]\+\.[0-9]\+/\1$NEW_VERSION/g" README.md
                  echo "Updated README.md version badge to $NEW_VERSION"

            - name: Update version in .Rproj file
              run: |
                  RPROJ_FILE=$(find . -maxdepth 1 -name "*.Rproj" | head -1)
                  if [ -f "$RPROJ_FILE" ]; then
                    # 精确匹配Version行
                    sed -i "s/^Version: [0-9]\+\.[0-9]\+\.[0-9]\+$/Version: $NEW_VERSION/" "$RPROJ_FILE"
                    echo "Updated $RPROJ_FILE version to $NEW_VERSION"
                  else
                    echo "No .Rproj file found"
                  fi

            - name: Pull latest changes
              run: |
                  git pull origin main --rebase
                  echo "Pulled latest changes"  

            - name: Commit all version updates
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

                  git add DESCRIPTION README.md

                  RPROJ_FILE=$(find . -maxdepth 1 -name "*.Rproj" | head -1)
                  if [ -f "$RPROJ_FILE" ] && git diff -- "$RPROJ_FILE" | grep -q "^+Version:"; then
                    git add "$RPROJ_FILE"
                  fi

                  git commit -m "Bump version to $NEW_VERSION [ci skip]"
                  git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"

                  git push origin main
                  git push origin "v$NEW_VERSION"
