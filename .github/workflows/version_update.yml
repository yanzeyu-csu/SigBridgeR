name: Update R Package Version

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    update-version:
        runs-on: ubuntu-latest
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            # 缓存R包依赖
            - name: Cache R packages
              uses: actions/cache@v3
              with:
                  path: |
                      ~/R/Library
                      /usr/local/lib/R/site-library
                      /usr/lib/R/site-library
                  key: ${{ runner.os }}-r-packages-${{ hashFiles('**/DESCRIPTION') }}
                  restore-keys: |
                      ${{ runner.os }}-r-packages-

            - name: Setup R
              uses: r-lib/actions/setup-r@v2

            # 只在缓存未命中时安装desc包
            - name: Install required packages
              run: |
                  if [ ! -d "~/R/Library/desc" ]; then
                    Rscript -e 'install.packages("desc")'
                  fi

            - name: Configure Git user
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

            - name: Get commit message
              id: commit_msg
              run: |
                  echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

            - name: Determine version bump type
              id: version_bump
              run: |
                # 将commit message转换为小写以便不区分大小写匹配
                commit_msg=$(echo "${{ steps.commit_msg.outputs.msg }}" | tr '[:upper:]' '[:lower:]')
                
                # 使用更精确的单词边界匹配，避免部分匹配
                if echo "$commit_msg" | grep -q "\<major\>\|\<breaking\>\|feat!"; then
                    echo "type=major" >> $GITHUB_OUTPUT
                    echo "Bump type: major" >&2
                elif echo "$commit_msg" | grep -q "\<feat\>\|\<feature\>\|\<minor\>"; then
                    echo "type=minor" >> $GITHUB_OUTPUT
                    echo "Bump type: minor" >&2
                elif echo "$commit_msg" | grep -q "\<patch\>\|\<fix\>\|\<bug\>"; then
                    echo "type=patch" >> $GITHUB_OUTPUT
                    echo "Bump type: patch" >&2
                else
                    echo "type=none" >> $GITHUB_OUTPUT
                    echo "Bump type: none (no version change)" >&2
                    exit 0
                fi

            - name: Update version in DESCRIPTION
              id: update_version
              if: steps.version_bump.outputs.type != 'none'
              run: |
                  CURRENT_VERSION=$(Rscript -e 'cat(as.character(desc::desc_get_version()))')
                  echo "Current version: $CURRENT_VERSION"

                  if [ "${{ steps.version_bump.outputs.type }}" = "major" ]; then
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[1] <- as.character(as.numeric(parts[1]) + 1); parts[2] <- "0"; parts[3] <- "0"; cat(paste(parts, collapse="."))')
                  elif [ "${{ steps.version_bump.outputs.type }}" = "minor" ]; then
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[2] <- as.character(as.numeric(parts[2]) + 1); parts[3] <- "0"; cat(paste(parts, collapse="."))')
                  elif [ "${{ steps.version_bump.outputs.type }}" = "patch" ]; then
                    NEW_VERSION=$(Rscript -e 'v <- as.character(desc::desc_get_version()); parts <- unlist(strsplit(v, "\\.")); parts[3] <- as.character(as.numeric(parts[3]) + 1); cat(paste(parts, collapse="."))')
                  fi

                  echo "New version: $NEW_VERSION"
                  Rscript -e "desc::desc_set_version('$NEW_VERSION')"
                  echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

            - name: Update version badge in README.md
              if: steps.version_bump.outputs.type != 'none'
              run: |
                  sed -i "s/\(badge\/devel%20version-\)[0-9]\+\.[0-9]\+\.[0-9]\+/\1$NEW_VERSION/g" README.md
                  echo "Updated README.md version badge to $NEW_VERSION"

            - name: Update version in .Rproj file
              if: steps.version_bump.outputs.type != 'none'              
              run: |
                  RPROJ_FILE=$(find . -maxdepth 1 -name "*.Rproj" | head -1)
                  if [ -f "$RPROJ_FILE" ]; then
                    sed -i "s/^Version: [0-9]\+\.[0-9]\+\.[0-9]\+$/Version: $NEW_VERSION/" "$RPROJ_FILE"
                    echo "Updated $RPROJ_FILE version to $NEW_VERSION"
                  else
                    echo "No .Rproj file found"
                  fi

            - name: Pull latest changes
              if: steps.version_bump.outputs.type != 'none'
              run: |
                  git fetch origin      # 先获取远程更新
                  git merge origin/main # 将远程更改合并到当前分支
                  echo "Pulled latest changes"

            - name: Commit all version updates
              if: steps.version_bump.outputs.type != 'none'
              run: |
                  git add DESCRIPTION README.md

                  RPROJ_FILE=$(find . -maxdepth 1 -name "*.Rproj" | head -1)
                  if [ -f "$RPROJ_FILE" ] && git diff -- "$RPROJ_FILE" | grep -q "^+Version:"; then
                    git add "$RPROJ_FILE"
                  fi

                  if git diff --staged --quiet; then
                    echo "No changes to commit."
                    exit 0
                  fi

                  git commit -m "Bump version to $NEW_VERSION [ci skip]"

                  if git show-ref --tags "v$NEW_VERSION"; then
                    echo "Tag v$NEW_VERSION already exists, skipping creation."
                  else
                    git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
                  fi

            - name: Push changes and tags
              if: steps.version_bump.outputs.type != 'none'
              run: |
                  git push origin main

                  if git show-ref --tags "v$NEW_VERSION"; then
                    git push origin "v$NEW_VERSION"
                  else
                    echo "No new tag to push."
                  fi
