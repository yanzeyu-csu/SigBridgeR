name: Render Rmd to Md

on:
    push:
        branches: [main]
        paths: ["vignettes/**.Rmd"]

permissions:
    contents: write

jobs:
    render:
        runs-on: ubuntu-latest
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: Cache R packages
              uses: actions/cache@v3
              with:
                  path: |
                      ~/R/Library
                      /usr/local/lib/R/site-library
                      /usr/lib/R/site-library
                  key: ${{ runner.os }}-r-packages-${{ hashFiles('**/DESCRIPTION') }}
                  restore-keys: |
                      ${{ runner.os }}-r-packages-

            - name: Setup R
              uses: r-lib/actions/setup-r@v2

            - name: Install pandoc
              uses: r-lib/actions/setup-pandoc@v2

            - name: Install dependencies
              run: |
                  if [ ! -d "~/R/Library/rmarkdown" ] || [ ! -d "~/R/Library/knitr" ]; then
                    Rscript -e 'install.packages(c("rmarkdown", "knitr", "reticulate"))'
                  fi

            - name: Render Rmd files
              run: |
                  # 1. 处理 vignettes 目录
                  if [ -d "vignettes" ]; then
                    echo "Processing vignettes directory..."
                    find vignettes -type f \( -iname "*.rmd" \) | while read -r file; do
                      output_file="$(basename "${file%.*}.md")"
                      echo "Rendering $file -> $output_file"
                      Rscript -e "library(knitr); opts_chunk\$set(eval = FALSE); rmarkdown::render('$file', output_format = 'md_document', output_file = '$output_file')" || {
                        echo "Failed to render $file"; exit 1
                      }
                    done
                  else
                    echo "vignettes/ 不存在，跳过渲染 vignettes。"
                  fi

            - name: Configure Git
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

            - name: Pull latest changes before commit
              run: |
                  git fetch origin
                  git merge origin/main

            - name: Commit results
              run: |
                  # 添加 vignettes 目录下的 md
                  if [ -d "vignettes" ]; then
                    git add vignettes/*.md 2>/dev/null || echo "No markdown files found in vignettes"
                  fi
                  # 添加根目录的 README.md
                  git add README.md 2>/dev/null || echo "No README.md to add"

                  if git diff --staged --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "Re-build vignettes and README from Rmd to Md"
                    git push origin main
                    echo "Changes pushed to repository."
                  fi
