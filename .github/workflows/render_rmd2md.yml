name: Render Rmd to Md

on:
    push:
        branches: [main]
        paths: ["vignettes/**.Rmd"] # 只监控 vignettes 目录中的 Rmd 文件

permissions:
    contents: write

jobs:
    render:
        runs-on: ubuntu-latest
        concurrency: 
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

             # 缓存R包依赖
            - name: Cache R packages
              uses: actions/cache@v3
              with:
                  path: |
                      ~/R/Library
                      /usr/local/lib/R/site-library
                      /usr/lib/R/site-library
                  key: ${{ runner.os }}-r-packages-${{ hashFiles('**/DESCRIPTION') }}
                  restore-keys: |
                      ${{ runner.os }}-r-packages-

            - name: Setup R
              uses: r-lib/actions/setup-r@v2

            - name: Install pandoc
              uses: r-lib/actions/setup-pandoc@v2

            - name: Install dependencies
              run: |
                  # 只有在缓存未命中时才安装包
                  if [ ! -d "~/R/Library/rmarkdown" ] || [ ! -d "~/R/Library/knitr" ]; then
                    Rscript -e 'install.packages(c("rmarkdown", "knitr"))'
                  fi

            - name: Render vignettes Rmd files
              run: |
                  if [ -d "vignettes" ]; then
                    echo "Processing vignettes directory..."
                    find vignettes -type f \( -name "*.Rmd" -o -name "*.rmd" \) | while read -r file; do
                      output_file="$(basename "${file%.*}.md")"  # Changed: use basename to strip 'vignettes/'
                      echo "Rendering $file to $output_file"
                      Rscript -e "library(knitr); opts_chunk\$set(eval = FALSE); rmarkdown::render('$file', output_format = 'md_document', output_file = '$output_file')" || {
                        echo "Failed to render $file"
                        exit 1
                      }
                    done
                  else
                    echo "vignettes directory does not exist, skipping."
                    exit 0
                  fi

            - name: Configure Git
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

            - name: Pull latest changes before commit
              run: |
                  # 在提交前拉取最新更改，避免冲突
                  git fetch origin 
                  git merge origin/main

            - name: Commit results
              run: |
                  # 只添加 vignettes 目录中的 md 文件
                  if [ -d "vignettes" ]; then
                    git add vignettes/*.md 2>/dev/null || echo "No markdown files found in vignettes"
                  fi

                  # 检查是否有更改需要提交
                  if git diff --staged --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "Re-build vignettes from Rmd to Md"
                    git push origin main
                    echo "Changes pushed to repository."
                  fi
