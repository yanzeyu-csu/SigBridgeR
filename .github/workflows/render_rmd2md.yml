name: Render Rmd to Md

on:
    push:
        branches: [main]
        paths: ["vignettes/**.Rmd"] # 只监控 vignettes 目录中的 Rmd 文件

permissions:
    contents: write

jobs:
    render:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set working directory
              run: cd $GITHUB_WORKSPACE

            - name: Setup R
              uses: r-lib/actions/setup-r@v2

            - name: Install pandoc
              uses: r-lib/actions/setup-pandoc@v2

            - name: Install dependencies
              uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  packages: |
                      rmarkdown
                      knitr

            - name: Render vignettes Rmd files
              run: |
                  if [ -d "vignettes" ]; then
                    echo "Processing vignettes directory..."
                    find vignettes -type f \( -name "*.Rmd" -o -name "*.rmd" \) | while read -r file; do
                      output_file="$(basename "${file%.*}.md")"  # Changed: use basename to strip 'vignettes/'
                      echo "Rendering $file to $output_file"
                      Rscript -e "library(knitr); opts_chunk\$set(eval = FALSE); rmarkdown::render('$file', output_format = 'md_document', output_file = '$output_file')" || {
                        echo "Failed to render $file"
                        exit 1
                      }
                    done
                  else
                    echo "vignettes directory does not exist, skipping."
                    exit 0
                  fi

            - name: Commit results
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

                  # 只添加 vignettes 目录中的 md 文件
                  if [ -d "vignettes" ]; then
                    git add vignettes/*.md 2>/dev/null || echo "No markdown files found in vignettes"
                  fi

                  git commit -m "Re-build Rmd files in vignettes" || echo "No changes to commit"
                  git push
