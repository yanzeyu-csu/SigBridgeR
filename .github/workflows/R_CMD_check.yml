# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
#
# See https://github.com/r-lib/actions/tree/master/examples#readme for
# additional example workflows available for the R community.

# ======================================================== #
# Determines when the action is triggered                  #
# ======================================================== #

on: [push, pull_request]
name: R-CMD-check

# ======================================================== #
# Determine actions to take                                #
# ======================================================== #

jobs:
    R-CMD-check:
        runs-on: ${{ matrix.config.os }}
        name: ${{ matrix.config.os }} (R ${{ matrix.config.r }})
        strategy:
            fail-fast: false
            matrix:
                config:
                    - { os: windows-latest, r: "release" }
                    - { os: macOS-latest, r: "release" }
                    - { os: ubuntu-latest, r: "release" }
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
            R_KEEP_PKG_SOURCE: yes
        steps:
            - name: Checking out the repository
              uses: actions/checkout@v4

            - name: Setting up pandoc
              uses: r-lib/actions/setup-pandoc@v2

            - name: Setting up R ${{ matrix.config.r }} on ${{ matrix.config.os }}
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: ${{ matrix.config.r }}
                  http-user-agent: ${{ matrix.config.http-user-agent }}
                  use-public-rspm: true

            # 对于 macOS，使用替代方法安装依赖
            - name: Install dependencies (macOS - alternative method)
              if: matrix.config.os == 'macOS-latest'
              run: |
                  # 安装 remotes 包
                  Rscript -e 'install.packages("remotes")'

                  # 从 DESCRIPTION 文件安装依赖
                  Rscript -e '
                  deps <- remotes::dev_package_deps(dependencies = TRUE)
                  remotes::install_deps(dependencies = TRUE, upgrade = "never")
                  '

                  Rscript -e 'if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")'

                  Rscript -e 'BiocManager::install(c("AUCell", "edgeR"))'

                  Rscript -e 'remotes::install_github("WangX-Lab/ScPP")'  
                  # 额外安装检查所需的包
                  Rscript -e 'install.packages("rcmdcheck")'

            # 对于非 macOS 系统，继续使用标准方法
            - name: Querying dependencies (non-macOS)
              if: matrix.config.os != 'macOS-latest'
              uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  extra-packages: |
                      any::rcmdcheck
                      any::pkgbuild
                  needs: check

            - name: Checking package
              uses: r-lib/actions/check-r-package@v2
              with:
                  upload-snapshots: true

            # 2. 构建包
            - name: Build package
              if: matrix.config.os == 'ubuntu-latest' # 任选一种 OS 执行一次即可
              run: |
                  Rscript -e 'if ("${{ matrix.config.type }}" == "source") {
                      pkgbuild::build(".", dest_path = ".", binary = FALSE)
                  } else {
                      pkgbuild::build(".", dest_path = ".", binary = TRUE)
                  }'
                  

            # 3. 上传至 Release（仅一次，避免重复）
            - name: Upload to Release
              if: matrix.config.os == 'ubuntu-latest' # 任选一种 OS 执行一次即可
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      *.tar.gz
                      *.zip
                      *.tgz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
