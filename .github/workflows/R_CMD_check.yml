on: [push, pull_request]
name: R-CMD-check

jobs:
    R-CMD-check:
        runs-on: ${{ matrix.config.os }}
        name: ${{ matrix.config.os }} (R ${{ matrix.config.r }})
        strategy:
            fail-fast: false
            matrix:
                config:
                    - { os: windows-latest, r: "release" }
                    - { os: macOS-latest, r: "release" }
                    - { os: ubuntu-latest, r: "release" }
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
            R_KEEP_PKG_SOURCE: yes
        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/setup-pandoc@v2

            - name: Set up R
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: ${{ matrix.config.r }}
                  use-public-rspm: true

            - name: Install Rtools (Windows)
              if: matrix.config.os == 'windows-latest'
              run: |
                  # Set up Rtools path for R
                  echo "PATH=${RTOOLS40_HOME}\\usr\\bin;${PATH}" >> ${HOME}/.Renviron
              shell: bash

            - name: Install system dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

            - name: Install dependencies
              run: |
                  # Install basic packages
                  Rscript -e "install.packages(c('remotes', 'rcmdcheck', 'Rcpp', 'devtools'), repos = 'https://cloud.r-project.org')"

                  # Install Bioconductor packages
                  Rscript -e "
                  if (!requireNamespace('BiocManager', quietly = TRUE)) 
                    install.packages('BiocManager', repos = 'https://cloud.r-project.org')
                  BiocManager::install(c('AUCell', 'edgeR', 'preprocessCore'), ask = FALSE)
                  "

                  # Install GitHub packages
                  Rscript -e "
                  remotes::install_github(c(
                    'ShixiangWang/IDConverter',
                    'Qinran-Zhang/scAB',
                    'sunduanchen/Scissor',
                    'aiminXie/scPAS',
                    'WangX-Lab/ScPP'
                  ))
                  "

                  # Install project dependencies
                  Rscript -e "remotes::install_deps(dependencies = TRUE, upgrade = 'never')"

            - name: Check package
              uses: r-lib/actions/check-r-package@v2
              with:
                  upload-snapshots: true
