# ======================================================== #
# Determines when the action is triggered                  #
# ======================================================== #

on: [push, pull_request]
name: R-CMD-check

# ======================================================== #
# Determine actions to take                                #
# ======================================================== #

jobs:
    R-CMD-check:
        runs-on: ${{ matrix.config.os }}
        name: ${{ matrix.config.os }} (R ${{ matrix.config.r }})
        strategy:
            fail-fast: false
            matrix:
                config:
                    - { os: windows-latest, r: "release" }
                    - { os: macOS-latest, r: "release" }
                    - { os: ubuntu-latest, r: "release" }
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
            R_KEEP_PKG_SOURCE: yes
        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/setup-pandoc@v2

            - name: Set up R ${{ matrix.config.r }}
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: ${{ matrix.config.r }}
                  use-public-rspm: true

            - name: Install Rtools (Windows only)
              if: matrix.config.os == 'windows-latest'
              uses: r-lib/actions/setup-rtools@v2
              with:
                  version: '4.0'

            - name: Install system dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

            - name: Install dependencies
              run: |
                  # 安装基本工具包
                  Rscript -e "install.packages(c('remotes', 'rcmdcheck', 'Rcpp', 'devtools'), repos = 'https://cloud.r-project.org')"
                  
                  # 安装 Bioconductor 包
                  Rscript -e "
                  if (!requireNamespace('BiocManager', quietly = TRUE)) 
                    install.packages('BiocManager', repos = 'https://cloud.r-project.org')
                  BiocManager::install(c(
                    'AUCell',
                    'edgeR',
                    'preprocessCore'
                  ),ask = FALSE)
                  "
                  
                  # 安装 GitHub 包
                  Rscript -e "
                  remotes::install_github('ShixiangWang/IDConverter')
                  remotes::install_github('Qinran-Zhang/scAB')
                  remotes::install_github('sunduanchen/Scissor')
                  remotes::install_github('aiminXie/scPAS')
                  remotes::install_github('WangX-Lab/ScPP')
                  "
                  
                  # 安装项目依赖
                  Rscript -e "remotes::install_deps(dependencies = TRUE, upgrade = 'never')"

            - name: Check package
              uses: r-lib/actions/check-r-package@v2
              with:
                  upload-snapshots: true